{% extends "base.html" %}

{% block content %}
<div class="chat-container" id="chat-container">
    <div class="message bot">
        <div class="message-content">
            <p>Hello! Upload a document (PDF/DOCX) to get started. You can ask questions about it, or use commands like
                <code>/summarize</code> and <code>/keyword</code>.
            </p>
        </div>
    </div>
</div>

<div class="input-area">
    <label for="file-upload" class="file-upload-label">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
                d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48">
            </path>
        </svg>
    </label>
    <input type="file" id="file-upload" style="display: none" onchange="uploadFile(this)">
    <input type="text" class="chat-input" id="chat-input" placeholder="Type a message or command..."
        onkeypress="handleKeyPress(event)">
    <button class="send-btn" onclick="sendMessage()">Send</button>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function uploadFile(input) {
        const file = input.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        addMessage('Uploading ' + file.name + '...', 'user');

        try {
            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.status === 'success') {
                addMessage('File uploaded successfully! You can now ask questions.', 'bot');
            } else {
                addMessage('Error uploading file: ' + data.error, 'bot');
            }
        } catch (e) {
            addMessage('Error uploading file.', 'bot');
        }
    }

    function handleKeyPress(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (!message) return;

        addMessage(message, 'user');
        input.value = '';

        // Add loading indicator
        const loadingId = addLoadingMessage();

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            });
            const data = await response.json();

            // Remove loading indicator
            removeMessage(loadingId);

            if (data.error) {
                addMessage('Error: ' + data.error, 'bot');
            } else {
                let content = data.response;
                if (data.sources && data.sources.length > 0) {
                    content += '\n\n**Sources:**\n';
                    data.sources.forEach(source => {
                        content += `- Page ${source.page}: ${source.text}\n`;
                    });
                }
                addMessage(content, 'bot');
            }
        } catch (e) {
            removeMessage(loadingId);
            addMessage('Error sending message.', 'bot');
        }
    }

    function addLoadingMessage() {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        const id = 'msg-' + Date.now();
        div.id = id;
        div.className = 'message bot';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.innerHTML = `
            <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        `;
        
        div.appendChild(contentDiv);
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        return id;
    }

    function removeMessage(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }

    function addMessage(text, sender) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content markdown-body';
        contentDiv.innerHTML = marked.parse(text);
        
        div.appendChild(contentDiv);
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }
</script>
{% endblock %}